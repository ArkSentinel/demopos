<style>
  :root {
    --pos-primary: #0d6efd;
    --pos-bg: #f8f9fa;
  }

  body { background-color: #f4f7f6; }

  .pos-wrapper { max-width: 100%; overflow-x: hidden; }
  
  .product-card {
    border-radius: 12px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid rgba(0,0,0,0.05) !important;
    background: white;
  }
  
  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 20px rgba(0,0,0,0.08) !important;
  }

  .product-img-container {
    height: 150px;
    background-color: var(--pos-bg);
    position: relative;
    overflow: hidden;
    border-bottom: 1px solid #f0f0f0;
  }

  .product-img {
    height: 100%;
    width: 100%;
    object-fit: cover;
  }

  .price-tag {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(13, 110, 253, 0.9);
    color: white;
    padding: 2px 12px;
    border-radius: 8px;
    font-weight: 700;
    backdrop-filter: blur(4px);
    font-size: 0.9rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  #cart-sticky {
    position: sticky;
    top: 20px;
    z-index: 10;
    max-height: calc(100vh - 40px);
    display: flex;
    flex-direction: column;
  }

  .cart-items-container {
    flex-grow: 1;
    overflow-y: auto;
    min-height: 200px;
    max-height: 450px;
  }

  .cart-items-container::-webkit-scrollbar { width: 6px; }
  .cart-items-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
</style>

<div class="container-fluid px-4 py-4 pos-wrapper">
  <div class="row g-4">
    
    <div id="products-section" class="col-xxl-9 col-xl-8 col-lg-7">
      
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <h2 class="fw-bold text-dark mb-0"><i class="bi bi-grid-fill me-2 text-primary"></i>Catálogo</h2>
        <span class="badge bg-white text-dark border p-2 px-3 shadow-sm">
          <i class="bi bi-box-seam me-1"></i> <%= @products.count %> Artículos
        </span>
      </div>

      <div class="card border-0 shadow-sm mb-4" style="border-radius: 15px;">
        <div class="card-body p-3">
          <%= form_with url: products_path, method: :get, local: true, class: "row g-2 align-items-center" do |f| %>
            <div class="col-md-6 col-lg-7">
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                <%= f.text_field :q, value: params[:q], class: "form-control border-0 bg-light", placeholder: "Buscar por nombre..." %>
              </div>
            </div>
            <div class="col-md-4 col-lg-3">
              <%= f.collection_select :category_id, Category.all, :id, :name, { include_blank: "Todas las categorías", selected: params[:category_id] }, { class: "form-select border-0 bg-light" } %>
            </div>
            <div class="col-md-2 d-grid">
              <%= f.submit "Filtrar", class: "btn btn-primary fw-bold" %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-2 row-cols-xl-3 row-cols-xxl-4 g-3">
        <% @products.each do |product| %>
          <div class="col">
            <div class="card h-100 product-card border-0">
              <div class="product-img-container">
                <% if product.photo.attached? %>
                  <%= image_tag product.photo, class: "product-img" %>
                <% else %>
                  <img src="https://via.placeholder.com/300x160.png?text=Sin+Imagen" class="product-img">
                <% end %>
                <div class="price-tag"><%= number_to_currency(product.price) %></div>
              </div>

              <div class="card-body p-3 d-flex flex-column">
                <h6 class="card-title fw-bold text-dark text-truncate mb-1"><%= product.name %></h6>
                <p class="card-text text-muted small mb-3" style="min-height: 35px;">
                  <%= truncate(product.description, length: 50) %>
                </p>
                
                <div class="mt-auto">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge <%= product.quantity > 5 ? 'bg-light text-success' : 'bg-light text-danger' %> rounded-pill p-2 px-3">
                      Stock: <%= product.quantity %>
                    </span>
                  </div>
                  
                  <div class="d-flex gap-2">
                    <%= link_to product, class: "btn btn-light btn-sm text-primary", title: "Detalles" do %>
                      <i class="bi bi-info-circle"></i>
                    <% end %>
                    <button type="button" class="btn btn-warning btn-sm flex-grow-1 fw-bold shadow-sm" 
                            onclick="addToCart(<%= product.id %>, '<%= j product.name %>', <%= product.price %>)">
                      <i class="bi bi-plus-lg me-1"></i> AGREGAR
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <div class="mt-5 d-flex justify-content-center">
        <%= paginate @products if defined?(paginate) %>
      </div>
    </div>

    <div id="cart-section" class="col-xxl-3 col-xl-4 col-lg-5">
      <div id="cart-sticky" class="card border-0 shadow-lg" style="border-radius: 15px; overflow: hidden;">
        <div class="card-header bg-dark text-white py-3 border-0">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold"><i class="bi bi-cart3 me-2 text-warning"></i>Orden Actual</h5>
            <button class="btn btn-sm btn-outline-light border-0" onclick="clearCart()"><i class="bi bi-trash"></i></button>
          </div>
        </div>
        
        <div class="card-body p-0 cart-items-container">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr class="small text-uppercase">
                  <th class="ps-3 py-3" style="font-size: 0.75rem;">Item</th>
                  <th class="text-center py-3" style="font-size: 0.75rem;">Cant.</th>
                  <th class="text-end pe-3 py-3" style="font-size: 0.75rem;">Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cart-body">
                </tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-white border-top-0 p-4">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="text-muted small">Subtotal</span>
            <span id="cart-subtotal" class="fw-bold">$0.00</span>
          </div>
          <hr class="my-2">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <span class="h5 fw-bold mb-0">TOTAL</span>
            <span id="cart-total" class="h3 mb-0 fw-bold text-primary">$0</span>
          </div>
          <button id="checkout-btn" class="btn btn-success btn-lg w-100 fw-bold shadow-sm py-3" style="border-radius: 12px;">
            <i class="bi bi-cash-stack me-2"></i> Finalizar compra
          </button>
        </div>
      </div>
    </div>

  </div>
</div>